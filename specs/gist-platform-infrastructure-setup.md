# Feature: Gist Platform Infrastructure Setup

## Feature Description
Establish the foundational infrastructure for the Gist Platform - a system that enables users to create shareable mini-sites (called "gists") at auto-provisioned URLs. This setup phase lays the groundwork for all subsequent features by integrating Convex as the real-time database, establishing logging/observability, creating API route stubs, and configuring the Next.js application with proper TypeScript paths and environment variables.

The infrastructure provides:
- **Convex Database Integration**: Real-time TypeScript-native database with schema for gists
- **Observability Foundation**: Structured logging system for monitoring all operations
- **API Route Architecture**: RESTful endpoints for widget integration and CRUD operations
- **Development Environment**: Proper configuration for Bun, Next.js, TypeScript, and Tailwind
- **Type Safety**: Strict TypeScript configuration with path aliases for clean imports

This is the "plumbing before fixtures" phase - establishing reliable infrastructure that subsequent features (preview generation, scraping, editing UI) will depend on.

## User Story
As a **platform developer**
I want to **have robust foundational infrastructure with database, logging, and API scaffolding**
So that **I can rapidly build gist creation, preview, and editing features with confidence in data persistence and observability**

## Problem Statement
The current Ask Anything UI codebase is optimized for embeddable widgets but lacks:
1. **Database Layer**: No persistent storage for user-generated content (gists)
2. **Backend Infrastructure**: No API routes for handling data operations
3. **Observability**: No structured logging for debugging and monitoring
4. **Gist Domain**: No data models, routes, or components for mini-site generation

Without this infrastructure, we cannot:
- Store gist data from the onboarding widget
- Generate preview URLs for users to review their mini-sites
- Track errors or monitor system health
- Build the scraper, generator, or editing features

## Solution Statement
Integrate Convex as the real-time database and build foundational infrastructure:

1. **Convex Integration**: Add Convex SDK, configure connection, define gists schema
2. **Logging System**: Create structured logger with prefixes (INIT, API, CONVEX, SCRAPE, GEN, ERROR)
3. **API Scaffolding**: Stub routes for `/api/create-preview`, `/api/scrape`, `/api/gist/[id]`
4. **Route Stubs**: Create placeholder pages for `/gistplatform`, `/[slug]`, `/preview/[slug]`
5. **Configuration**: Set up TypeScript paths, environment variables, Convex deployment

**Tech Stack Compliance**: This solution strictly uses approved technologies:
- **Bun**: All package management and script execution (`bun add convex`, `bun run dev`)
- **Next.js 15.4.5**: App Router for dynamic routes and API handlers
- **React 19.1.0**: Client components for future interactive features
- **TypeScript 5.9.2**: Strict mode with path aliases
- **Tailwind CSS v4**: Styling system (already configured, no changes needed)
- **Convex 1.17.2**: Real-time database (NEW dependency, justified below)

**New Dependency Justification**:
- `convex@^1.17.2`: Required for real-time database with TypeScript-native schema, built-in auth support, and instant client synchronization. Alternative approaches (PostgreSQL + Prisma, Supabase) would require more boilerplate and don't provide real-time sync out of the box. Convex aligns with the requirement for "no laggy database queries" and supports the preview editing workflow where changes need to appear instantly.

## Relevant Files

### Existing Files (Modify)
- **`package.json`**: Add Convex dependency, add `convex:dev` script for parallel development
  - Needs: `convex@^1.17.2` in dependencies
  - Needs: `"convex:dev": "convex dev"` script

- **`tsconfig.json`**: Already has `@/*` path alias configured
  - Review: Ensure strict mode enabled (already is)
  - Confirm: Path aliases work for new `/lib` and `/convex` directories

- **`next.config.ts`**: Currently minimal, may need Convex-specific config
  - Add: Convex domain to allowed remote patterns (if using images)

- **`.env.local`**: Environment variables for Convex connection
  - Add: `CONVEX_DEPLOYMENT`, `NEXT_PUBLIC_CONVEX_URL`

- **`app/page.tsx`**: Currently shows ðŸš§ emoji
  - Modify: Update to link to `/gistplatform` entry point

- **`lib/utils.ts`**: Already has `cn()` helper
  - Keep: Existing utility functions
  - Add: Logger import for any future utility functions

### New Files

#### Configuration & Infrastructure
- **`.env.local.example`**: Template for environment variables
  - Variables: `CONVEX_DEPLOYMENT`, `NEXT_PUBLIC_CONVEX_URL`, `WIDGET_SCRIPT_URL`

- **`convex.json`**: Convex project configuration
  - Generated by: `bunx convex dev` command

#### Database Layer (`/convex`)
- **`convex/schema.ts`**: Gists table schema with all fields
  - Fields: slug (indexed), status, type, title, goal, audience, vibe, source_url, userId, hero, tiles, scraped_data, created_at

- **`convex/gists.ts`**: Query/mutation functions for gists CRUD
  - Functions: `list()`, `getBySlug()`, `create()`, `update()`, `delete()`

- **`convex/tsconfig.json`**: TypeScript config for Convex functions
  - Generated by: Convex CLI

#### Business Logic (`/lib`)
- **`lib/logger.ts`**: Structured logging utility
  - Functions: `log.init()`, `log.api()`, `log.convex()`, `log.scrape()`, `log.gen()`, `log.error()`

- **`lib/convex.ts`**: Convex client initialization
  - Export: Configured `ConvexReactClient` instance

- **`lib/scraper.ts`**: URL metadata scraper (stub implementation)
  - Function: `scrapeUrl(url: string)` â†’ returns mock data for now

- **`lib/generator.ts`**: Content generator from scraped data (stub)
  - Function: `generateGistContent(data)` â†’ returns hero + tiles structure

#### API Routes (`/app/api`)
- **`app/api/create-preview/route.ts`**: POST endpoint for widget data
  - Handler: Returns `{ message: "Not implemented" }` stub

- **`app/api/scrape/route.ts`**: POST endpoint for URL scraping
  - Handler: Returns `{ message: "Not implemented" }` stub

- **`app/api/gist/[id]/route.ts`**: CRUD operations for specific gist
  - Handlers: GET, PATCH, DELETE stubs

#### Page Routes (`/app`)
- **`app/gistplatform/page.tsx`**: Entry point at `/gistplatform`
  - Content: Onboarding widget variant with "Create Gist" CTA

- **`app/[slug]/page.tsx`**: Public mini-site view (dynamic route)
  - Content: Returns 404 stub for now

- **`app/preview/[slug]/page.tsx`**: Editable preview with sidebar
  - Content: Returns 404 stub for now

#### Component Stubs (`/components`)
- **`components/mini-site/MiniSiteLayout.tsx`**: Wrapper component stub
- **`components/mini-site/HeroSection.tsx`**: Hero section stub
- **`components/mini-site/TileGrid.tsx`**: Content tiles stub
- **`components/mini-site/FloatingCTA.tsx`**: Morphing button stub
- **`components/preview/Sidebar.tsx`**: Editing sidebar stub
- **`components/preview/StepsUI.tsx`**: Questions 7-10 UI stub

## Implementation Plan
**IMPORTANT**: All implementation must strictly follow the Tech Stack Requirements (Bun, Next.js 15, React 19, TypeScript, Tailwind CSS v4, shadcn/ui).

### Phase 1: Foundation (Environment & Dependencies)
**Goal**: Install Convex, configure environment variables, verify connection

1. Add Convex to project dependencies via Bun
2. Create environment variable template
3. Initialize Convex project and get deployment URL
4. Configure Next.js to recognize Convex environment variables
5. Verify Convex dev server runs alongside Next.js

**Success Criteria**:
- `bun install` completes without errors
- `bunx convex dev` starts and shows deployment URL
- `.env.local` exists with valid `NEXT_PUBLIC_CONVEX_URL`

### Phase 2: Core Implementation (Schema, Logger, Utilities)
**Goal**: Define data models, create logging system, build utility functions

1. Create Convex schema with gists table
2. Implement Convex query/mutation functions
3. Build structured logger with all prefixes
4. Create Convex client wrapper
5. Implement scraper and generator stubs
6. Push schema to Convex deployment

**Success Criteria**:
- Schema visible in Convex dashboard
- Logger functions work with correct prefixes
- Convex client can be imported in components

### Phase 3: Integration (Routes, Pages, Components)
**Goal**: Wire up API routes, create page stubs, scaffold component structure

1. Create API route stubs with logger integration
2. Build `/gistplatform` entry page with onboarding widget
3. Create dynamic route stubs for `[slug]` and `preview/[slug]`
4. Scaffold mini-site component stubs
5. Scaffold preview component stubs
6. Update homepage to link to `/gistplatform`

**Success Criteria**:
- All routes accessible and return expected stubs
- Logger messages appear in terminal
- TypeScript path aliases resolve correctly

## Step by Step Tasks
IMPORTANT: Execute every step in order, top to bottom.

### 1. Install Convex Dependency
- Run `bun add convex` to install Convex SDK
- Verify `package.json` includes `convex@^1.17.2` in dependencies
- Run `bun install` to ensure lock file is updated

### 2. Create Environment Variable Template
- Create `.env.local.example` file with:
  ```
  CONVEX_DEPLOYMENT=
  NEXT_PUBLIC_CONVEX_URL=
  WIDGET_SCRIPT_URL=https://widget-deploy-hazel.vercel.app/widget.js
  ```
- Add comment headers explaining each variable
- Ensure `.env.local` is in `.gitignore` (already should be)

### 3. Initialize Convex Project
- Run `bunx convex dev` to initialize Convex project
- Follow prompts to create new project or link existing
- Copy `CONVEX_DEPLOYMENT` and `NEXT_PUBLIC_CONVEX_URL` to `.env.local`
- Verify `convex.json` is created in project root
- Verify `convex/_generated/` directory appears

### 4. Create Convex Schema
- Create `convex/schema.ts` with gists table definition
- Define all fields: slug (v.string(), indexed), status (v.union), type, title, goal, audience, vibe, source_url, userId, hero (v.object), tiles (v.array), scraped_data (v.object), created_at (v.number)
- Add index on `slug` field for fast lookups
- Push schema with `bunx convex dev` (should auto-deploy)

### 5. Implement Convex Query/Mutation Functions
- Create `convex/gists.ts` with CRUD operations
- Implement `listGists()` query to return all gists
- Implement `getGistBySlug(slug: string)` query
- Implement `createGist(args)` mutation with validation
- Implement `updateGist(id, updates)` mutation
- Implement `deleteGist(id)` mutation
- Test functions in Convex dashboard

### 6. Create Structured Logger
- Create `lib/logger.ts` with timestamp formatting utility
- Implement `log.init(message: string)` â†’ `[INIT] timestamp message`
- Implement `log.api(message: string)` â†’ `[API] timestamp message`
- Implement `log.convex(message: string)` â†’ `[CONVEX] timestamp message`
- Implement `log.scrape(message: string)` â†’ `[SCRAPE] timestamp message`
- Implement `log.gen(message: string)` â†’ `[GEN] timestamp message`
- Implement `log.error(message: string, error?: Error)` â†’ `[ERROR] timestamp message + stack`
- Add TypeScript types for all functions
- Test logger by importing and calling functions

### 7. Create Convex Client Wrapper
- Create `lib/convex.ts` to initialize Convex client
- Import `ConvexReactClient` from `convex/react`
- Export configured client using `NEXT_PUBLIC_CONVEX_URL`
- Add error handling if env var missing
- Document usage with JSDoc comments

### 8. Implement Scraper Stub
- Create `lib/scraper.ts` with `scrapeUrl(url: string)` function
- Return mock metadata object: `{ title, description, og_image, primary_color }`
- Add TODO comment for future implementation (will use Cheerio or similar)
- Add TypeScript interface for `ScrapedData`
- Import and use logger: `log.scrape()`

### 9. Implement Generator Stub
- Create `lib/generator.ts` with `generateGistContent(data)` function
- Return mock hero object: `{ headline, subhead, style, media_url, cta }`
- Return mock tiles array: `[{ id, kind, title, content }]`
- Add TypeScript interfaces for `HeroData`, `TileData`, `GeneratedContent`
- Import and use logger: `log.gen()`

### 10. Create API Route: Create Preview
- Create `app/api/create-preview/route.ts` with POST handler
- Import logger and call `log.api("POST /api/create-preview received")`
- Return JSON: `{ message: "Not implemented" }` with 501 status
- Add TypeScript types for request/response
- Test with `curl -X POST http://localhost:3000/api/create-preview`

### 11. Create API Route: Scrape URL
- Create `app/api/scrape/route.ts` with POST handler
- Import logger and call `log.api("POST /api/scrape received")`
- Return JSON: `{ message: "Not implemented" }` with 501 status
- Add TypeScript types for request/response
- Test with `curl -X POST http://localhost:3000/api/scrape`

### 12. Create API Route: Gist CRUD
- Create `app/api/gist/[id]/route.ts` with GET, PATCH, DELETE handlers
- Import logger and call appropriate `log.api()` for each method
- Return JSON: `{ message: "Not implemented" }` with 501 status for all
- Add TypeScript types using Next.js `NextRequest`, `NextResponse`
- Test with `curl http://localhost:3000/api/gist/test-id`

### 13. Create Gist Platform Entry Page
- Create `app/gistplatform/page.tsx` as client component
- Import and render onboarding widget (adapt from `/onboarding` pattern)
- Add heading: "Create Your Gist"
- Add subheading explaining the platform
- Use existing `OnboardingWidget` component
- Import logger and call `log.init("Gist Platform page loaded")`
- Style with Tailwind CSS utilities

### 14. Create Dynamic Slug Route Stub
- Create `app/[slug]/page.tsx` as async server component
- Accept `params: { slug: string }` as prop
- Import logger and call `log.init(\`Public gist page: ${slug}\`)`
- Return simple div: "Public gist: {slug} - Coming Soon"
- Add TypeScript types for `PageProps`
- Test by visiting `http://localhost:3000/test-slug`

### 15. Create Preview Slug Route Stub
- Create `app/preview/[slug]/page.tsx` as async server component
- Accept `params: { slug: string }` as prop
- Import logger and call `log.init(\`Preview gist page: ${slug}\`)`
- Return simple div: "Preview gist: {slug} - Coming Soon"
- Add TypeScript types for `PageProps`
- Test by visiting `http://localhost:3000/preview/test-slug`

### 16. Scaffold Mini-Site Components
- Create `components/mini-site/MiniSiteLayout.tsx` stub (returns children)
- Create `components/mini-site/HeroSection.tsx` stub (returns "Hero Section")
- Create `components/mini-site/TileGrid.tsx` stub (returns "Tile Grid")
- Create `components/mini-site/FloatingCTA.tsx` stub (returns shadcn Button)
- Add TypeScript prop interfaces for each component
- Export all components from `components/mini-site/index.ts` barrel file

### 17. Scaffold Preview Components
- Create `components/preview/Sidebar.tsx` stub (returns "Sidebar")
- Create `components/preview/StepsUI.tsx` stub (returns "Steps UI")
- Add TypeScript prop interfaces for each component
- Export all components from `components/preview/index.ts` barrel file

### 18. Update Homepage
- Modify `app/page.tsx` to remove ðŸš§ emoji
- Add heading: "Ask Anything UI"
- Add link to `/gistplatform` with description
- Add link to `/widgets` (existing page)
- Add link to `/onboarding` (existing page)
- Style with Tailwind CSS utilities
- Test navigation works

### 19. Add Convex Dev Script
- Modify `package.json` to add `"convex:dev": "convex dev"` script
- Update README or add comment about running `bun run convex:dev` in parallel
- Consider adding `"dev:all": "concurrently \"bun run dev\" \"bun run convex:dev\""` (requires `bun add -d concurrently`)

### 20. Run All Validation Commands
- Execute every validation command below
- Fix any errors that appear
- Verify green lights everywhere
- Document any warnings or notices

## Testing Strategy

### Unit Tests
**Note**: Testing infrastructure uses Bun's test runner with happy-dom and Testing Library.

- **Logger Tests** (`tests/lib/logger.test.ts`):
  - Test each log function outputs correct prefix
  - Test timestamp formatting
  - Test error logging includes stack trace
  - Verify console output matches expected format

- **Utility Function Tests** (`tests/lib/scraper.test.ts`, `tests/lib/generator.test.ts`):
  - Test scraper returns correct mock data structure
  - Test generator returns correct mock data structure
  - Verify TypeScript types are correct

- **Convex Client Tests** (`tests/lib/convex.test.ts`):
  - Test client initialization
  - Test error handling for missing env vars
  - Mock Convex client and verify configuration

### Integration Tests
- **API Route Tests** (`tests/api/*.test.ts`):
  - Test each API route returns 501 "Not implemented"
  - Verify logger calls are made
  - Test request/response types

- **Page Render Tests** (`tests/pages/*.test.ts`):
  - Test `/gistplatform` renders onboarding widget
  - Test `[slug]` and `preview/[slug]` return stub content
  - Verify logger calls on page load

- **Convex Schema Tests**:
  - Verify schema deployed to Convex
  - Test query functions return empty arrays initially
  - Test mutation functions validate required fields

### Edge Cases
- **Missing Environment Variables**:
  - Test app behavior when `NEXT_PUBLIC_CONVEX_URL` is missing
  - Verify error messages are clear

- **Invalid Slug Parameters**:
  - Test `[slug]` and `preview/[slug]` with special characters
  - Test URL encoding/decoding

- **Convex Connection Failures**:
  - Test graceful degradation if Convex unavailable
  - Verify error logging

- **Concurrent Dev Servers**:
  - Test Next.js and Convex dev running simultaneously
  - Verify hot reload works for both

## Acceptance Criteria
All criteria must be met for feature to be considered complete:

- [ ] Dependencies installed: `bun install` completes without errors
- [ ] Convex initialized: `bunx convex dev` starts and connects
- [ ] Environment variables: `.env.local` exists with valid Convex URLs
- [ ] Schema deployed: Convex dashboard shows `gists` table with all fields
- [ ] Logger working: All log functions output correct prefixes
- [ ] API routes accessible: All `/api/*` routes return 501 stubs
- [ ] Pages accessible: `/gistplatform`, `/[slug]`, `/preview/[slug]` render
- [ ] Component stubs created: All mini-site and preview components exist
- [ ] TypeScript compiles: No type errors with `tsc --noEmit`
- [ ] Next.js builds: `bun run build` succeeds
- [ ] Tests pass: `bun test` runs without failures
- [ ] Linting passes: `bun run lint` shows no errors
- [ ] Homepage updated: Links to gist platform visible

## Validation Commands
Execute every command to validate the feature works correctly with zero regressions.

```bash
# 1. Verify dependencies installed
bun install
# â†’ Should complete without errors

# 2. Verify Convex dev server starts
bunx convex dev
# â†’ Should show deployment URL and connect
# â†’ Keep running in separate terminal

# 3. Start Next.js dev server
bun run dev
# â†’ Should start on http://localhost:3000
# â†’ Terminal should show [INIT] messages

# 4. Visit homepage
open http://localhost:3000
# â†’ Should show links to /gistplatform
# â†’ Console should show [INIT] Page loaded

# 5. Visit gist platform entry
open http://localhost:3000/gistplatform
# â†’ Should render onboarding widget
# â†’ Terminal should show [INIT] Gist Platform page loaded

# 6. Test API health check
curl http://localhost:3000/api/create-preview -X POST
# â†’ Should return: {"message":"Not implemented"}
# â†’ Terminal should show [API] POST /api/create-preview received

curl http://localhost:3000/api/scrape -X POST
# â†’ Should return: {"message":"Not implemented"}
# â†’ Terminal should show [API] POST /api/scrape received

curl http://localhost:3000/api/gist/test-id
# â†’ Should return: {"message":"Not implemented"}
# â†’ Terminal should show [API] GET /api/gist/test-id received

# 7. Test dynamic routes
open http://localhost:3000/test-slug
# â†’ Should show "Public gist: test-slug - Coming Soon"

open http://localhost:3000/preview/test-slug
# â†’ Should show "Preview gist: test-slug - Coming Soon"

# 8. Check Convex dashboard
open https://dashboard.convex.dev
# â†’ Project should exist
# â†’ `gists` table should be visible (empty)
# â†’ Schema should show all fields

# 9. TypeScript type checking
bunx tsc --noEmit
# â†’ Should complete with 0 errors

# 10. Run linting
bun run lint
# â†’ Should pass with no errors

# 11. Run tests
bun test
# â†’ All tests should pass
# â†’ Coverage should include logger, routes, pages

# 12. Build application
bun run build
# â†’ Should complete successfully
# â†’ .next/ directory should be created

# 13. Test production build
bun run start
# â†’ Should start production server
# â†’ Visit http://localhost:3000 to verify
```

## Notes

### Convex Development Workflow
- **Parallel Dev Servers**: Run `bunx convex dev` in one terminal and `bun run dev` in another
- **Schema Changes**: Auto-deploy when you save `convex/schema.ts`
- **Function Updates**: Auto-deploy when you save `convex/*.ts` files
- **Dashboard Access**: https://dashboard.convex.dev to view data and logs

### TypeScript Path Aliases
- Current config: `@/*` maps to project root
- Usage: `import { logger } from "@/lib/logger"`
- Applies to: `/lib`, `/components`, `/convex`, `/app`

### Environment Variable Precedence
- `.env.local` (never committed, local overrides)
- `.env.local.example` (committed, template)
- Next.js only exposes `NEXT_PUBLIC_*` vars to browser
- Server-only vars (like `CONVEX_DEPLOYMENT`) are safe

### Future Enhancements (Out of Scope)
These will be implemented in subsequent features:
- **URL Scraping Logic**: Replace stub with real Cheerio/Puppeteer implementation
- **Content Generation**: Replace stub with AI-powered content generation
- **Preview Generation**: Build actual mini-site from scraped data
- **Editing Interface**: Build sidebar with answer cards and live preview
- **Publishing Flow**: Implement status change from "preview" to "public"

### Migration from Widgets
- Existing onboarding widget in `/onboarding` serves as reference
- Gist platform will use adapted version of this widget
- Widget will POST to `/api/create-preview` after question 6
- API will trigger scraper â†’ generator â†’ Convex save â†’ redirect flow

### Debugging Tips
- Use logger prefixes to trace execution flow
- Check Convex dashboard for deployed schema and data
- Use Next.js dev server logs to see API route calls
- Run `bunx convex logs` to see Convex function execution logs
- Verify environment variables with `console.log(process.env.NEXT_PUBLIC_CONVEX_URL)`
